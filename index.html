<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Defense Game v1.15</title>
    <style>
        /* Same styles as before, just a reminder to adjust health bar colors */
        .health-bar {
            height: 10px;
            width: 100%;
            background-color: #ccc;
            border: 1px solid #aaa;
            position: relative;
            overflow: hidden; /* Ensures red fills the empty part */
        }
        .health {
            height: 100%;
            background-color: green;
        }
        .missing-health {
            height: 100%;
            background-color: red;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%; /* Initially cover the whole bar */
            transform: scaleX(0); /* Start with zero width */
            transition: transform 0.3s; /* Smooth transition */
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>Defense Game</h1>
        <div class="points-container">
            <div>
                <p>Player 1 Points: <span id="player1Points">12</span></p>
                <div class="health-bar" id="fort1HealthContainer">
                    <div class="health" id="fort1Health" style="width: 100%;"></div>
                    <div class="missing-health" id="fort1MissingHealth" style="transform: scaleX(0);"></div>
                </div>
            </div>
            <div>
                <p>Player 2 Points: <span id="player2Points">12</span></p>
                <div class="health-bar" id="fort2HealthContainer">
                    <div class="health" id="fort2Health" style="width: 100%;"></div>
                    <div class="missing-health" id="fort2MissingHealth" style="transform: scaleX(0);"></div>
                </div>
            </div>
        </div>
        <div class="board" id="gameBoard"></div>
        <p id="message"></p>
        <div class="end-screen" id="endScreen" style="display: none;">
            <p id="winnerMessage"></p>
            <button class="reset-button" onclick="resetGame()">Reset Game</button>
        </div>
    </div>
    
    <script>
        const board = document.getElementById('gameBoard');
        const messageDisplay = document.getElementById('message');
        const fort1HealthBar = document.getElementById('fort1Health');
        const fort2HealthBar = document.getElementById('fort2Health');
        const fort1MissingHealth = document.getElementById('fort1MissingHealth');
        const fort2MissingHealth = document.getElementById('fort2MissingHealth');
        const endScreen = document.getElementById('endScreen');
        const winnerMessage = document.getElementById('winnerMessage');
        const gridSize = 9;

        let currentPlayer = 1;
        let playerFortHealth = [10, 10];
        let turretHealth = [3, 3];
        let turrets = [[], []];
        let playerPoints = [12, 12];
        let boardState = Array.from({ length: gridSize }, () => Array(gridSize).fill(null));

        // Fort positions
        const fort1 = { row: 4, col: 0 };
        const fort2 = { row: 4, col: gridSize - 1 };
        boardState[fort1.row][fort1.col] = 'Fort1';
        boardState[fort2.row][fort2.col] = 'Fort2';

        initializeBoard();

        function initializeBoard() {
            board.innerHTML = '';
            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.row = i;
                    cell.dataset.col = j;
                    cell.addEventListener('click', () => handleCellClick(i, j));
                    board.appendChild(cell);
                }
            }
            updateHealthBars();
        }

        function updateHealthBars() {
            const fort1HealthPercent = (playerFortHealth[0] / 10);
            const fort2HealthPercent = (playerFortHealth[1] / 10);
            fort1HealthBar.style.width = `${fort1HealthPercent * 100}%`;
            fort2HealthBar.style.width = `${fort2HealthPercent * 100}%`;
            fort1MissingHealth.style.transform = `scaleX(${1 - fort1HealthPercent})`;
            fort2MissingHealth.style.transform = `scaleX(${1 - fort2HealthPercent})`;

            const cells = document.querySelectorAll('.cell');
            cells.forEach(cell => {
                const row = cell.dataset.row;
                const col = cell.dataset.col;
                cell.textContent = boardState[row][col] || '';
                cell.classList.remove('fort', 'fort2', 'turret', 'turret2');
                if (boardState[row][col] === 'Fort1') {
                    cell.classList.add('fort');
                } else if (boardState[row][col] === 'Fort2') {
                    cell.classList.add('fort2');
                } else if (cell.textContent.startsWith('Turret')) {
                    const playerIndex = cell.textContent.endsWith('1') ? 0 : 1;
                    cell.classList.add('turret' + (playerIndex + 1));
                    const healthDisplay = '-'.repeat(turretHealth[playerIndex]);
                    cell.innerHTML += `<div class="turret-health">${cell.textContent} - ${healthDisplay}</div>`;
                }
            });
        }

        function handleCellClick(row, col) {
            if (boardState[row][col] === null) {
                if (canPlaceTurret(row, col)) {
                    if (playerPoints[currentPlayer - 1] >= 3) {
                        boardState[row][col] = `Turret${currentPlayer}`;
                        turrets[currentPlayer - 1].push({ row, col });
                        playerPoints[currentPlayer - 1] -= 3;
                        updateHealthBars();
                        fireTurret(row, col, currentPlayer - 1); // Fire immediately
                        startTurretFire(row, col, currentPlayer - 1); // Start turret firing at intervals
                        endTurn();
                    } else {
                        messageDisplay.textContent = 'Not enough points to place a turret!';
                    }
                } else {
                    messageDisplay.textContent = 'Turrets can only be placed adjacent to your structures!';
                }
            } else {
                messageDisplay.textContent = 'Cell already occupied!';
            }
        }

        function canPlaceTurret(row, col) {
            const adjacentCells = [
                { r: row - 1, c: col }, { r: row + 1, c: col },
                { r: row, c: col - 1 }, { r: row, c: col + 1 }
            ];
            return adjacentCells.some(cell => {
                const { r, c } = cell;
                return r >= 0 && r < gridSize && c >= 0 && c < gridSize &&
                    (boardState[r][c] && boardState[r][c].startsWith(`Turret${currentPlayer}`) || boardState[r][c] === `Fort${currentPlayer}`);
            });
        }

        function fireTurret(row, col, playerIndex) {
            const turretCell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
            if (turretCell) {
                const target = findTarget(playerIndex);
                if (target) {
                    createBullet(turretCell, target.row, target.col, playerIndex);
                }
            }
        }

        function createBullet(turretCell, targetRow, targetCol, playerIndex) {
            const bullet = document.createElement('div');
            bullet.className = 'bullet';
            bullet.style.left = `${turretCell.offsetLeft + 35}px`; // Center bullet horizontally
            bullet.style.top = `${turretCell.offsetTop + 35}px`; // Center bullet vertically
            board.appendChild(bullet);

            const targetX = targetCol * 70 + 35; // Center of target cell
            const targetY = targetRow * 70 + 35; // Center of target cell
            const dx = targetX - (turretCell.offsetLeft + 35); // Adjust for bullet's center
            const dy = targetY - (turretCell.offsetTop + 30); // Adjust for bullet's center
            const distance = Math.sqrt(dx * dx + dy * dy);
            const speed = 2; // Adjust speed as needed

            const moveBullet = setInterval(() => {
                const bulletX = parseFloat(bullet.style.left) + (dx / distance) * speed;
                const bulletY = parseFloat(bullet.style.top) + (dy / distance) * speed;

                bullet.style.left = `${bulletX}px`;
                bullet.style.top = `${bulletY}px`;

                const currentRow = Math.floor(bulletY / 70);
                const currentCol = Math.floor(bulletX / 70);

                if (currentRow >= 0 && currentRow < gridSize && currentCol >= 0 && currentCol < gridSize) {
                    const structure = boardState[currentRow][currentCol];
                    if (structure) {
                        clearInterval(moveBullet); // Stop the bullet
                        handleHit(currentRow, currentCol, playerIndex);
                        bullet.remove(); // Remove bullet after hit
                    }
                }

                // Check if the bullet has reached the target
                if (Math.abs(bulletX - targetX) < 5 && Math.abs(bulletY - targetY) < 5) {
                    clearInterval(moveBullet); // Stop the bullet when it reaches the target
                    bullet.remove(); // Remove bullet when it reaches the target
                }
            }, 20); // Adjust timing for smoother animation
        }

        function findTarget(playerIndex) {
            const targetPlayerIndex = playerIndex === 0 ? 1 : 0;
            const targets = [];

            // Check for enemy fort
            targets.push({ row: targetPlayerIndex === 0 ? fort2.row : fort1.row, col: targetPlayerIndex === 0 ? fort2.col : fort1.col });

            // Check for enemy turrets
            turrets[targetPlayerIndex].forEach(turret => {
                targets.push({ row: turret.row, col: turret.col });
            });

            // Find the nearest target
            let closestTarget = null;
            let closestDistance = Infinity;

            targets.forEach(target => {
                const dx = target.col - (playerIndex === 0 ? fort1.col : fort2.col);
                const dy = target.row - (playerIndex === 0 ? fort1.row : fort2.row);
                const distance = Math.sqrt(dx * dx + dy * dy);
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestTarget = target;
                }
            });

            return closestTarget;
        }

        function handleHit(row, col, playerIndex) {
            const structure = boardState[row][col];
            if (structure === 'Fort1' || structure === 'Fort2') {
                playerFortHealth[playerIndex]--;
                if (playerFortHealth[playerIndex] <= 0) {
                    endGame(playerIndex);
                }
            } else if (structure.startsWith('Turret')) {
                const turretIndex = structure.endsWith('1') ? 0 : 1;
                turretHealth[turretIndex]--;
                if (turretHealth[turretIndex] <= 0) {
                    removeTurret(row, col);
                }
            }
            updateHealthBars();
        }

        function removeTurret(row, col) {
            const turretIndex = boardState[row][col].endsWith('1') ? 0 : 1;
            turrets[turretIndex] = turrets[turretIndex].filter(t => !(t.row === row && t.col === col));
            boardState[row][col] = null;
            updateHealthBars();
        }

        function startTurretFire(row, col, playerIndex) {
            const firingInterval = setInterval(() => {
                if (boardState[row][col] === `Turret${playerIndex + 1}`) {
                    fireTurret(row, col, playerIndex);
                } else {
                    clearInterval(firingInterval); // Stop firing if turret is removed
                }
            }, 1000);
        }

        function endTurn() {
            currentPlayer = currentPlayer === 1 ? 2 : 1;
            messageDisplay.textContent = `Player ${currentPlayer}'s turn`;
        }

        function endGame(losingPlayerIndex) {
            const winningPlayerIndex = losingPlayerIndex === 0 ? 1 : 0;
            winnerMessage.textContent = `Player ${winningPlayerIndex + 1} Wins!`;
            endScreen.style.display = 'block';
            messageDisplay.textContent = '';
            clearAllBullets(); // Clear all bullets when the game ends
        }

        function clearAllBullets() {
            const bullets = document.querySelectorAll('.bullet');
            bullets.forEach(bullet => bullet.remove());
            // Stop turret firing
            clearInterval(turretFireInterval);
        }

        function resetGame() {
            playerFortHealth = [10, 10];
            turretHealth = [3, 3];
            turrets = [[], []];
            playerPoints = [12, 12];
            boardState = Array.from({ length: gridSize }, () => Array(gridSize).fill(null));
            initializeBoard();
            endScreen.style.display = 'none';
            currentPlayer = 1;
            messageDisplay.textContent = `Player ${currentPlayer}'s turn`;
            clearAllBullets(); // Ensure bullets are cleared on reset
        }
    </script>
</body>
</html>
