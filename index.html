<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Defense Game v1.9</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #f0f0f0;
        }
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px;
        }
        .board {
            display: grid;
            grid-template-columns: repeat(9, 70px);
            grid-template-rows: repeat(9, 70px);
            gap: 5px;
            margin: 20px 0;
        }
        .cell {
            width: 70px;
            height: 70px;
            background-color: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #aaa;
            cursor: pointer;
            position: relative;
        }
        .fort {
            background-color: #8ecae6; /* Player 1 Fort */
            position: relative;
        }
        .turret {
            background-color: #0077b6; /* Player 1 Turrets */
            position: relative;
        }
        .fort2, .turret2 {
            background-color: #ff6f61; /* Player 2 Structures */
        }
        .bullet {
            width: 10px;
            height: 10px;
            background-color: #ff3e00; /* Bullets */
            border-radius: 50%;
            position: absolute;
            transition: transform 0.5s linear; /* Move bullets smoothly */
        }
        .health-bar {
            height: 20px;
            width: 100%;
            background-color: #ccc;
            border: 1px solid #aaa;
            margin: 5px 0;
        }
        .health {
            height: 100%;
            background-color: green;
        }
        .turret-health {
            font-size: 12px;
            color: darkred;
        }
        .end-screen {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border: 2px solid black;
            z-index: 10;
        }
        .reset-button {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>Defense Game</h1>
        <div class="controls">
            <div style="display: flex; justify-content: space-between; width: 100%;">
                <div>
                    <p>Player 1 Points: <span id="player1Points">12</span></p>
                    <div class="health-bar" id="fort1HealthContainer">
                        <div class="health" id="fort1Health" style="width: 100%;"></div>
                    </div>
                </div>
                <div>
                    <p>Player 2 Points: <span id="player2Points">12</span></p>
                    <div class="health-bar" id="fort2HealthContainer">
                        <div class="health" id="fort2Health" style="width: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="board" id="gameBoard"></div>
        <p id="message"></p>
        <div class="end-screen" id="endScreen">
            <p id="winnerMessage"></p>
            <button class="reset-button" onclick="resetGame()">Reset Game</button>
        </div>
    </div>
    
    <script>
        const board = document.getElementById('gameBoard');
        const messageDisplay = document.getElementById('message');
        const player1PointsDisplay = document.getElementById('player1Points');
        const player2PointsDisplay = document.getElementById('player2Points');
        const fort1HealthBar = document.getElementById('fort1Health');
        const fort2HealthBar = document.getElementById('fort2Health');
        const endScreen = document.getElementById('endScreen');
        const winnerMessage = document.getElementById('winnerMessage');
        const gridSize = 9;

        let currentPlayer = 1;
        let playerFortHealth = [10, 10]; // Health for player 1 and 2 forts
        let turretHealth = [3, 3]; // Health for turrets
        let turrets = [[], []]; // Array to hold turret positions
        let playerPoints = [12, 12]; // Points for each player
        let boardState = Array(gridSize).fill().map(() => Array(gridSize).fill(null));
        let pointInterval; // Interval for point gain

        // Place forts automatically on the left and right
        const fort1 = { row: 4, col: 0 };
        const fort2 = { row: 4, col: gridSize - 1 };
        boardState[fort1.row][fort1.col] = 'Fort1';
        boardState[fort2.row][fort2.col] = 'Fort2';

        // Initialize the game board
        initializeBoard();

        function initializeBoard() {
            board.innerHTML = ''; // Clear previous cells
            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.row = i;
                    cell.dataset.col = j;
                    cell.addEventListener('click', () => handleCellClick(i, j));
                    board.appendChild(cell);
                }
            }
            boardState[fort1.row][fort1.col] = 'Fort1';
            boardState[fort2.row][fort2.col] = 'Fort2';
            updateHealthBars();
            startTurretFire(); // Start periodic firing
        }

        // Function to display health bars
        function updateHealthBars() {
            fort1HealthBar.style.width = `${(playerFortHealth[0] / 10) * 100}%`;
            fort2HealthBar.style.width = `${(playerFortHealth[1] / 10) * 100}%`;

            const cells = document.querySelectorAll('.cell');
            cells.forEach(cell => {
                const row = cell.dataset.row;
                const col = cell.dataset.col;
                cell.textContent = boardState[row][col] || '';
                cell.classList.remove('fort', 'fort2', 'turret', 'turret2');
                if (boardState[row][col] === 'Fort1') {
                    cell.classList.add('fort');
                } else if (boardState[row][col] === 'Fort2') {
                    cell.classList.add('fort2');
                } else if (cell.textContent.startsWith('Turret')) {
                    const playerIndex = cell.textContent.endsWith('1') ? 0 : 1;
                    cell.classList.add('turret' + (playerIndex + 1));
                    const healthDisplay = '-'.repeat(turretHealth[playerIndex]);
                    cell.innerHTML += `<div class="turret-health">${healthDisplay}</div>`;
                }
            });
        }

        function handleCellClick(row, col) {
            if (boardState[row][col] === null) {
                if (canPlaceTurret(row, col)) {
                    if (playerPoints[currentPlayer - 1] >= 3) {
                        boardState[row][col] = `Turret${currentPlayer}`;
                        turrets[currentPlayer - 1].push({ row, col });
                        playerPoints[currentPlayer - 1] -= 3; // Deduct points for placing a turret
                        updateHealthBars();
                        fireTurret(row, col, currentPlayer - 1); // Fire immediately
                        endTurn(); // End the turn after placing a turret
                    } else {
                        messageDisplay.textContent = 'Not enough points to place a turret!';
                    }
                } else {
                    messageDisplay.textContent = 'Turrets can only be placed adjacent to your structures!';
                }
            } else {
                messageDisplay.textContent = 'Cell already occupied!';
            }
        }

        function canPlaceTurret(row, col) {
            const adjacentCells = [
                { r: row - 1, c: col }, { r: row + 1, c: col },
                { r: row, c: col - 1 }, { r: row, c: col + 1 }
            ];
            return adjacentCells.some(cell => {
                const { r, c } = cell;
                return r >= 0 && r < gridSize && c >= 0 && c < gridSize &&
                    (boardState[r][c] && boardState[r][c].startsWith(`Turret${currentPlayer}`) || boardState[r][c] === `Fort${currentPlayer}`);
            });
        }

        function fireTurret(row, col, playerIndex) {
            setInterval(() => {
                if (playerFortHealth[1 - playerIndex] > 0) {
                    const bullet = createBullet(row, col, playerIndex);
                    board.appendChild(bullet);
                    moveBullet(bullet, playerIndex);
                }
            }, 2000);
        }

        function createBullet(row, col, playerIndex) {
            const bullet = document.createElement('div');
            bullet.className = 'bullet';
            bullet.style.left = `${col * 75 + 30}px`; // Centering the bullet
            bullet.style.top = `${row * 75 + 30}px`;
            return bullet;
        }

        function moveBullet(bullet, playerIndex) {
            const target = findTarget(bullet, playerIndex);
            if (target) {
                const { row, col } = target;
                const bulletInterval = setInterval(() => {
                    // Move bullet toward target
                    bullet.style.left = `${parseInt(bullet.style.left) + (col - parseInt(bullet.style.left) / 75) * 2}px`;
                    bullet.style.top = `${parseInt(bullet.style.top) + (row - parseInt(bullet.style.top) / 75) * 2}px`;

                    // Check for collision
                    if (checkCollision(bullet, target)) {
                        applyDamage(target, playerIndex);
                        clearInterval(bulletInterval);
                        bullet.remove();
                    }

                    // Check if bullet goes out of bounds
                    if (parseInt(bullet.style.left) < 0 || parseInt(bullet.style.left) > 70 * gridSize || 
                        parseInt(bullet.style.top) < 0 || parseInt(bullet.style.top) > 70 * gridSize) {
                        clearInterval(bulletInterval);
                        bullet.remove();
                    }
                }, 50);
            }
        }

        function findTarget(bullet, playerIndex) {
            const enemies = [];
            // Check for the fort first
            const enemyFort = playerIndex === 0 ? fort2 : fort1;
            if (isWithinRange(bullet, enemyFort)) {
                enemies.push(enemyFort);
            }

            // Check for turrets
            turrets[1 - playerIndex].forEach(turret => {
                if (isWithinRange(bullet, turret)) {
                    enemies.push(turret);
                }
            });

            return enemies.length > 0 ? enemies[0] : null; // Prioritize the first target found
        }

        function isWithinRange(bullet, target) {
            const bulletRow = parseInt(bullet.style.top) / 75;
            const bulletCol = parseInt(bullet.style.left) / 75;
            const targetRow = target.row;
            const targetCol = target.col;

            const distance = Math.sqrt(Math.pow(targetRow - bulletRow, 2) + Math.pow(targetCol - bulletCol, 2));
            return distance <= 4; // 4 grid squares
        }

        function checkCollision(bullet, target) {
            // Collision logic can be improved depending on exact positions
            const bulletRow = parseInt(bullet.style.top) / 75;
            const bulletCol = parseInt(bullet.style.left) / 75;
            return target.row === bulletRow && target.col === bulletCol;
        }

        function applyDamage(target, playerIndex) {
            if (target === fort1) {
                playerFortHealth[1] -= 1;
            } else if (target === fort2) {
                playerFortHealth[0] -= 1;
            } else {
                // For turrets, identify which turret it is
                const turretIndex = turrets[1 - playerIndex].findIndex(t => t.row === target.row && t.col === target.col);
                if (turretIndex > -1) {
                    turretHealth[1 - playerIndex] -= 1;
                    if (turretHealth[1 - playerIndex] <= 0) {
                        boardState[target.row][target.col] = null; // Remove turret from board
                        turrets[1 - playerIndex].splice(turretIndex, 1); // Remove turret from array
                    }
                }
            }
            updateHealthBars();
            checkGameOver();
        }

        function checkGameOver() {
            if (playerFortHealth[0] <= 0) {
                endGame(2);
            } else if (playerFortHealth[1] <= 0) {
                endGame(1);
            }
        }

        function endGame(winner) {
            messageDisplay.textContent = '';
            endScreen.style.display = 'block';
            winnerMessage.textContent = `Player ${winner} wins!`;
            clearInterval(pointInterval); // Stop point gain
            stopTurretFire(); // Stop turret firing
        }

        function resetGame() {
            playerFortHealth = [10, 10];
            turretHealth = [3, 3];
            turrets = [[], []];
            playerPoints = [12, 12];
            boardState = Array(gridSize).fill().map(() => Array(gridSize).fill(null));
            initializeBoard();
            endScreen.style.display = 'none';
            messageDisplay.textContent = '';
            startTurretFire(); // Restart turret firing
            pointInterval = setInterval(gainPoints, 5000); // Start point gain again
        }

        function endTurn() {
            currentPlayer = currentPlayer === 1 ? 2 : 1;
            messageDisplay.textContent = `Player ${currentPlayer}'s turn!`;
            updatePointsDisplay();
        }

        function updatePointsDisplay() {
            player1PointsDisplay.textContent = playerPoints[0];
            player2PointsDisplay.textContent = playerPoints[1];
        }

        function startTurretFire() {
            setInterval(() => {
                turrets.forEach((turretList, playerIndex) => {
                    turretList.forEach(turret => {
                        fireTurret(turret.row, turret.col, playerIndex);
                    });
                });
            }, 2000);
        }

        function stopTurretFire() {
            // Logic to stop turret firing can be implemented here
        }

        function gainPoints() {
            playerPoints[currentPlayer - 1] += 1; // Gain points for current player
            updatePointsDisplay();
        }
    </script>
</body>
</html>
