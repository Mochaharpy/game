<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Defense Game v1.7</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #f0f0f0;
        }
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px;
        }
        .board {
            display: grid;
            grid-template-columns: repeat(9, 80px);
            grid-template-rows: repeat(9, 80px);
            gap: 5px;
            margin: 20px 0;
        }
        .cell {
            width: 80px;
            height: 80px;
            background-color: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #aaa;
            cursor: pointer;
            position: relative;
        }
        .fort { background-color: #8ecae6; }
        .turret { background-color: #0077b6; }
        .fort2, .turret2 { background-color: #ff6f61; }
        .bullet {
            width: 10px;
            height: 10px;
            background-color: #ff3e00;
            border-radius: 50%;
            position: absolute;
            transition: transform 1s; /* Slower bullet */
        }
        .health-bar {
            height: 10px;
            width: 100%;
            background-color: #ccc;
            border: 1px solid #aaa;
            margin: 5px 0;
        }
        .health { height: 100%; background-color: green; }
        .turret-health { font-size: 12px; color: darkred; }
        .end-screen {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border: 2px solid black;
            z-index: 10;
        }
        .reset-button { margin-top: 10px; }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>Defense Game</h1>
        <div class="controls">
            <div>
                <p>Player 1 Points: <span id="player1Points">12</span></p>
                <div class="health-bar" id="fort1HealthContainer">
                    <div class="health" id="fort1Health" style="width: 100%;"></div>
                </div>
            </div>
            <div>
                <p>Player 2 Points: <span id="player2Points">12</span></p>
                <div class="health-bar" id="fort2HealthContainer">
                    <div class="health" id="fort2Health" style="width: 100%;"></div>
                </div>
            </div>
        </div>
        <div class="board" id="gameBoard"></div>
        <p id="message"></p>
        <div class="end-screen" id="endScreen">
            <p id="winnerMessage"></p>
            <button class="reset-button" onclick="resetGame()">Reset Game</button>
        </div>
    </div>
    
    <script>
        const board = document.getElementById('gameBoard');
        const messageDisplay = document.getElementById('message');
        const player1PointsDisplay = document.getElementById('player1Points');
        const player2PointsDisplay = document.getElementById('player2Points');
        const fort1HealthBar = document.getElementById('fort1Health');
        const fort2HealthBar = document.getElementById('fort2Health');
        const endScreen = document.getElementById('endScreen');
        const winnerMessage = document.getElementById('winnerMessage');
        const gridSize = 9;

        let currentPlayer = 1;
        let playerFortHealth = [10, 10];
        let turretHealth = [3, 3];
        let turrets = [[], []];
        let playerPoints = [12, 12];
        let boardState = Array.from({ length: gridSize }, () => Array(gridSize).fill(null));
        let pointInterval;

        const fortPositions = [{ row: 4, col: 0 }, { row: 4, col: gridSize - 1 }];
        boardState[fortPositions[0].row][fortPositions[0].col] = 'Fort1';
        boardState[fortPositions[1].row][fortPositions[1].col] = 'Fort2';

        initializeBoard();

        function initializeBoard() {
            board.innerHTML = '';
            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                    const cell = createCell(i, j);
                    board.appendChild(cell);
                }
            }
            updateHealthBars();
            startTurretFire();
        }

        function createCell(row, col) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.dataset.row = row;
            cell.dataset.col = col;
            cell.addEventListener('click', () => handleCellClick(row, col));
            if (boardState[row][col]) updateCellClass(cell, row, col);
            return cell;
        }

        function updateCellClass(cell, row, col) {
            cell.textContent = boardState[row][col];
            cell.classList.remove('fort', 'fort2', 'turret', 'turret2');
            if (boardState[row][col] === 'Fort1') cell.classList.add('fort');
            if (boardState[row][col] === 'Fort2') cell.classList.add('fort2');
            if (boardState[row][col]?.startsWith('Turret')) {
                const playerIndex = boardState[row][col].endsWith('1') ? 0 : 1;
                cell.classList.add('turret' + (playerIndex + 1));
                const healthDisplay = '-'.repeat(turretHealth[playerIndex]);
                cell.innerHTML += `<div class="turret-health">${healthDisplay}</div>`;
            }
        }

        function updateHealthBars() {
            fort1HealthBar.style.width = `${(playerFortHealth[0] / 10) * 100}%`;
            fort2HealthBar.style.width = `${(playerFortHealth[1] / 10) * 100}%`;
            player1PointsDisplay.textContent = playerPoints[0];
            player2PointsDisplay.textContent = playerPoints[1];
            updateBoardDisplay();
        }

        function updateBoardDisplay() {
            const cells = document.querySelectorAll('.cell');
            cells.forEach(cell => {
                const row = cell.dataset.row;
                const col = cell.dataset.col;
                if (boardState[row][col]) updateCellClass(cell, row, col);
                else cell.textContent = '';
            });
        }

        function handleCellClick(row, col) {
            if (!boardState[row][col] && canPlaceTurret(row, col)) {
                if (playerPoints[currentPlayer - 1] >= 3) {
                    placeTurret(row, col);
                } else {
                    messageDisplay.textContent = 'Not enough points to place a turret!';
                }
            } else {
                messageDisplay.textContent = 'Cell already occupied!';
            }
        }

        function canPlaceTurret(row, col) {
            const adjacentCells = [
                { r: row - 1, c: col }, { r: row + 1, c: col },
                { r: row, c: col - 1 }, { r: row, c: col + 1 }
            ];
            return adjacentCells.some(cell => {
                const { r, c } = cell;
                return r >= 0 && r < gridSize && c >= 0 && c < gridSize &&
                    (boardState[r][c]?.startsWith(`Turret${currentPlayer}`) || boardState[r][c] === `Fort${currentPlayer}`);
            });
        }

        function placeTurret(row, col) {
            boardState[row][col] = `Turret${currentPlayer}`;
            turrets[currentPlayer - 1].push({ row, col });
            playerPoints[currentPlayer - 1] -= 3;
            playerPoints[currentPlayer - 1]++;
            updateHealthBars();
            fireTurret(row, col, currentPlayer - 1);
            endTurn();
        }

        function fireTurret(row, col, playerIndex) {
            const turretCell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
            if (turretCell) {
                const target = findTarget(playerIndex);
                if (target) {
                    createBullet(turretCell, target);
                }
            }
        }

        function createBullet(turretCell, target) {
            const bullet = document.createElement('div');
            bullet.className = 'bullet';
            turretCell.appendChild(bullet);

            const targetCell = document.querySelector(`.cell[data-row="${target.row}"][data-col="${target.col}"]`);
            const dx = targetCell.offsetLeft - turretCell.offsetLeft;
            const dy = targetCell.offsetTop - turretCell.offsetTop;

            bullet.style.transform = `translate(${dx}px, ${dy}px)`;

            bullet.addEventListener('transitionend', () => {
                bullet.remove();
                checkCollision(target);
            });
        }

        function checkCollision(target) {
            const targetCell = boardState[target.row][target.col];
            if (targetCell === `Fort${getOpponent() + 1}`) {
                playerFortHealth[getOpponent()]--;
                if (playerFortHealth[getOpponent()] <= 0) endGame(getOpponent() + 1);
            } else if (targetCell?.startsWith('Turret')) {
                const turretIndex = getOpponent();
                turretHealth[turretIndex]--;
                if (turretHealth[turretIndex] <= 0) destroyTurret(target);
            }
            updateHealthBars();
        }

        function destroyTurret(target) {
            const { row, col } = target;
            boardState[row][col] = null;
            playerPoints[getOpponent()] += 3;
            updateHealthBars();
        }

        function findTarget(playerIndex) {
            const opponentIndex = getOpponent();
            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                    if (boardState[i][j] === `Fort${opponentIndex + 1}` || 
                        (boardState[i][j]?.startsWith('Turret') && !boardState[i][j].endsWith(`${playerIndex + 1}`))) {
                        return { row: i, col: j };
                    }
                }
            }
            return null;
        }

        function getOpponent() {
            return currentPlayer === 1 ? 1 : 0;
        }

        function endGame(winner) {
            winnerMessage.textContent = `Player ${winner} wins!`;
            endScreen.style.display = 'block';
            clearInterval(pointInterval);
            document.querySelectorAll('.cell').forEach(cell => cell.style.pointerEvents = 'none');
        }

        function endTurn() {
            currentPlayer = currentPlayer === 1 ? 2 : 1;
            updateHealthBars();
        }

        function resetGame() {
            currentPlayer = 1;
            playerFortHealth = [10, 10];
            turretHealth = [3, 3];
            playerPoints = [12, 12];
            boardState = Array.from({ length: gridSize }, () => Array(gridSize).fill(null));
            endScreen.style.display = 'none';
            initializeBoard();
            document.querySelectorAll('.cell').forEach(cell => cell.style.pointerEvents = 'auto');
        }

        function startTurretFire() {
            setInterval(() => {
                turrets.forEach((playerTurrets, index) => {
                    playerTurrets.forEach(({ row, col }) => fireTurret(row, col, index));
                });
            }, 2000);
        }

        pointInterval = setInterval(() => {
            playerPoints[0]++;
            playerPoints[1]++;
            updateHealthBars();
        }, 5000);

        updateHealthBars();
    </script>
</body>
</html>
